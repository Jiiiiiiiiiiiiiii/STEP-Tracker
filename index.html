<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>STEP Tracker — Guardian Dashboard</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
body{margin:0;font-family:sans-serif;background:#111;color:#fff;}
#map{width:70%;height:100vh;float:left;}
.panel{width:30%;height:100vh;float:left;background:#222;padding:20px;overflow:auto;}
.info{margin-bottom:10px;padding:10px;background:#333;border-radius:8px;}
.status{padding:8px;border-radius:6px;text-align:center;}
.status-ok{background:#4CAF50;color:#000;}
.status-alert{background:#ff4d4d;color:#000;}
</style>
</head>
<body>

<div id="map"></div>
<div class="panel">
  <div class="info"><b>Last Location:</b> <span id="latlng">—</span></div>
  <div class="info"><b>Street:</b> <span id="street">—</span></div>
  <div class="info"><b>Last Update:</b> <span id="lastUpdate">—</span></div>
  <div class="info"><b>Distance to Obstacle:</b> <span id="distance">— cm</span></div>
  <div class="info"><b>Battery:</b> <span id="battery">—%</span></div>
  <div id="alerts" class="status status-ok">No Alerts</div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyCEPsPPxprCkb70JAre73vo0jo3YA6uZQ4",
  authDomain: "step-gps-tracker.firebaseapp.com",
  databaseURL: "https://step-gps-tracker-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "step-gps-tracker",
  storageBucket: "step-gps-tracker.firebasestorage.app",
  messagingSenderId: "637274580153",
  appId: "1:637274580153:web:7566f774dbf5ea4380a768"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Leaflet Map
const defaultLat=14.3, defaultLng=121.4;
const map=L.map('map').setView([defaultLat,defaultLng],16);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

const marker=L.marker([defaultLat,defaultLng]).addTo(map);
let pathCoords=[]; 
let pathLine=L.polyline(pathCoords,{color:'#FFD400',weight:4}).addTo(map);

// DOM Elements
const latlngEl=document.getElementById('latlng');
const streetEl=document.getElementById('street');
const lastUpdateEl=document.getElementById('lastUpdate');
const distanceEl=document.getElementById('distance');
const batteryEl=document.getElementById('battery');
const alertsEl=document.getElementById('alerts');

async function getStreet(lat,lng){
  try{
    const res=await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`);
    const data=await res.json();
    return data.address ? (data.address.road || data.display_name) : 'Unknown';
  }catch(e){ return 'Unknown';}
}

// Firebase Listener
db.ref('shoe').on('value', async snap=>{
  const data = snap.val();
  if(!data) return;
  const lat = data.latitude || defaultLat;
  const lng = data.longitude || defaultLng;

  marker.setLatLng([lat,lng]);
  map.panTo([lat,lng],{animate:true,duration:0.3});

  pathCoords.push([lat,lng]);
  if(pathCoords.length>200) pathCoords.shift();
  pathLine.setLatLngs(pathCoords);

  latlngEl.textContent=`${lat.toFixed(6)}, ${lng.toFixed(6)}`;
  lastUpdateEl.textContent=new Date().toLocaleTimeString();
  distanceEl.textContent=data.distance ? `${data.distance.toFixed(1)} cm` : '— cm';

  const batteryPercent=Math.round((data.battery-3.0)/(4.2-3.0)*100);
  batteryEl.textContent=`${batteryPercent}%`;

  streetEl.textContent=await getStreet(lat,lng);

  if(data.sos){
    alertsEl.textContent="⚠️ SOS — Send Help!";
    alertsEl.className="status status-alert";
    new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg").play();
    if(navigator.vibrate) navigator.vibrate(500);
  }else{
    alertsEl.textContent="✅ No Alerts";
    alertsEl.className="status status-ok";
  }
});
</script>
</body>
</html>
