<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>S.T.E.P Guardian Monitoring</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
body{margin:0;font-family:'Poppins',sans-serif;background:#0b0b0b;color:#fff;}
#map{height:100vh;width:100%;}
.info-panel{
  position:absolute;top:15px;left:15px;width:320px;background:rgba(20,20,20,0.9);
  padding:20px;border-radius:15px;z-index:1000;box-shadow:0 0 20px #FFD400;
  backdrop-filter:blur(10px);
}
.info-panel h2{
  color:#FFD400;text-align:center;margin-bottom:12px;font-weight:700;
  text-shadow:0 0 10px #FFD400;
}
.info-row{display:flex;justify-content:space-between;margin-bottom:10px;font-size:16px;}
.status-pill{padding:8px 10px;border-radius:10px;font-weight:700;text-align:center;}
.safe{background:#4CAF50;color:#000;}
.warning{background:#FFC107;color:#000;}
.alert{background:#FF5252;color:#000;}
#centerBtn{
  margin-top:10px;width:100%;padding:10px;border:none;background:#FFD400;
  color:#000;font-weight:700;border-radius:10px;cursor:pointer;
  transition:0.3s;
}
#centerBtn:hover{background:#fff04d;}
.leaflet-container{background:#000;}
</style>
</head>
<body>
<div id="map"></div>
<div class="info-panel">
  <h2>STEP Guardian</h2>
  <div class="info-row">Latitude: <span id="lat">â€”</span></div>
  <div class="info-row">Longitude: <span id="lng">â€”</span></div>
  <div class="info-row">Distance: <span id="distance">â€”</span> cm</div>
  <div class="info-row">Status: <span id="status" class="status-pill safe">Safe</span></div>
  <button id="centerBtn">ğŸ“ Center Map</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// ==========================
// ğŸ”¥ Firebase Configuration
// ==========================
const firebaseConfig = {
  apiKey: "AIzaSyCEPsPPxprCkb70JAre73vo0jo3YA6uZQ4",
  authDomain: "step-gps-tracker.firebaseapp.com",
  databaseURL: "https://step-gps-tracker-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "step-gps-tracker",
  storageBucket: "step-gps-tracker.firebasestorage.app",
  messagingSenderId: "637274580153",
  appId: "1:637274580153:web:7566f774dbf5ea4380a768"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

// ==========================
// ğŸ—ºï¸ Leaflet Map Setup
// ==========================
const defaultLat=14.3, defaultLng=121.4;
const map=L.map('map').setView([defaultLat,defaultLng],17);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom:19,attribution:'Â© OpenStreetMap'
}).addTo(map);

// ğŸ‘Ÿ Shoe icon (no box)
const shoeIcon = L.divIcon({
  html:'<span style="font-size:35px;">ğŸ‘Ÿ</span>',
  className:'shoe-icon',
  iconSize:[35,35],
  iconAnchor:[17,17]
});
let marker=L.marker([defaultLat,defaultLng],{icon:shoeIcon}).addTo(map).bindPopup('S.T.E.P Device');
let pathCoords=[];
let pathLine=L.polyline(pathCoords,{color:'#FFD400',weight:4,opacity:0.9}).addTo(map);

// ==========================
// ğŸ“Š UI Elements
// ==========================
const latEl=document.getElementById('lat');
const lngEl=document.getElementById('lng');
const distanceEl=document.getElementById('distance');
const statusEl=document.getElementById('status');
const centerBtn=document.getElementById('centerBtn');
centerBtn.addEventListener('click',()=>map.panTo(marker.getLatLng()));

// ==========================
// ğŸ” Realtime Firebase Listener
// ==========================
db.ref('shoe').on('value',snap=>{
  const data=snap.val();
  if(!data) return;

  const lat=data.latitude||defaultLat;
  const lng=data.longitude||defaultLng;
  let distance=data.distance;

  if(distance<0 || distance>500) distance=200; // treat invalid as safe

  // Move marker smoothly
  marker.setLatLng([lat,lng]);
  pathCoords.push([lat,lng]);
  if(pathCoords.length>200) pathCoords.shift();
  pathLine.setLatLngs(pathCoords);

  // Center view once
  map.panTo([lat,lng],{animate:true,duration:0.5});

  // Update info
  latEl.textContent=lat.toFixed(6);
  lngEl.textContent=lng.toFixed(6);
  distanceEl.textContent=distance.toFixed(1);

  // ğŸ§  Status Logic
  if(distance>=150){
    statusEl.textContent="âœ… Safe";
    statusEl.className='status-pill safe';
  }else if(distance>=30 && distance<150){
    statusEl.textContent="ğŸŸ¡ Mild Warning";
    statusEl.className='status-pill warning';
  }else{
    statusEl.textContent="ğŸ”´ SOS â€” Send Help!";
    statusEl.className='status-pill alert';
  }
});

setTimeout(()=>map.invalidateSize(),100);
</script>
</body>
</html>
