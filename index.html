<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>S.T.E.P ‚Äî Guardian Dashboard (Realtime)</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --bg:#0d0d0d; --card:#141414; --accent:#FFD400; --text:#eaeaea;
      --muted:#999; --danger:#ff4d4d; --warning:#FFC107; --success:#4CAF50;
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Poppins',sans-serif}
    html,body,#map{height:100%}
    body{background:var(--bg);color:var(--text);display:flex;flex-direction:column}

    header{
      background:linear-gradient(90deg,#000,#111,#222);
      padding:14px 20px;border-bottom:2px solid var(--accent);
      display:flex;align-items:center;justify-content:space-between;color:var(--accent);
      box-shadow:0 0 12px rgba(255,212,0,0.14);font-weight:700
    }

    .container{display:grid;grid-template-columns: 2fr 1fr; height:calc(100vh - 64px);}

    #map{width:100%;height:100%}

    .panel{
      background:var(--card); padding:22px; border-left:2px solid #222;
      display:flex;flex-direction:column; gap:14px; overflow:auto;
    }

    .title{font-size:20px;color:var(--accent);text-align:center;font-weight:700}
    .info-row{display:flex;justify-content:space-between;align-items:center;background:#0f0f0f;padding:10px;border-radius:10px;border:1px solid #222}
    .info-row span.value{color:var(--accent);font-weight:700}
    .status-pill{padding:10px 12px;border-radius:10px;text-align:center;font-weight:800}
    .safe{background:var(--success);color:#000}
    .mild{background:var(--warning);color:#000}
    .danger{background:var(--danger);color:#000}

    .controls{margin-top:auto; display:flex; gap:10px}
    button{flex:1;padding:11px;border-radius:10px;border:none;background:var(--accent);color:#000;font-weight:700;cursor:pointer}
    button:hover{background:#ffe44d; transform:scale(1.02)}

    /* marker bounce animation smoothing */
    .leaflet-marker-icon{transition: transform 0.6s ease !important}

    @media(max-width:900px){
      .container{grid-template-columns:1fr;grid-template-rows:1fr 0.95fr}
      .panel{border-left:none;border-top:2px solid #222}
    }
  </style>
</head>
<body>
  <header>
    <div>üëü S.T.E.P ‚Äî Guardian Monitoring</div>
    <div id="connectStatus" class="status-pill safe" style="background:var(--muted);color:#fff">Connecting...</div>
  </header>

  <div class="container">
    <div id="map"></div>

    <div class="panel" role="region" aria-label="Device information panel">
      <div class="title">Device Information</div>

      <div class="info-row"><div>Last Location</div><div class="value" id="latlng">‚Äî , ‚Äî</div></div>
      <div class="info-row"><div>Last Update</div><div class="value" id="lastUpdate">‚Äî</div></div>
      <div class="info-row"><div>Distance to Obstacle</div><div class="value" id="distance">‚Äî cm</div></div>
      <div class="info-row"><div>GPS Status</div><div class="value" id="gpsStatus">‚Äî</div></div>

      <div id="alerts" class="status-pill safe" style="text-align:center">No alerts</div>

      <div class="controls">
        <button id="centerBtn" aria-label="Center map on device">üìç Center Map</button>
        <button id="followBtn" aria-pressed="true">üîÅ Follow</button>
      </div>
    </div>
  </div>

  <!-- Firebase + Leaflet -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
  // ====== Firebase config (use your project's keys) ======
  const firebaseConfig = {
    apiKey: "AIzaSyCEPsPPxprCkb70JAre73vo0jo3YA6uZQ4",
    authDomain: "step-gps-tracker.firebaseapp.com",
    databaseURL: "https://step-gps-tracker-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "step-gps-tracker",
    storageBucket: "step-gps-tracker.firebasestorage.app",
    messagingSenderId: "637274580153",
    appId: "1:637274580153:web:7566f774dbf5ea4380a768"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // ====== Map setup ======
  const defaultLat = 14.3, defaultLng = 121.4; // fallback coordinates
  const map = L.map('map', {zoomControl:true}).setView([defaultLat, defaultLng], 16);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'¬© OpenStreetMap contributors'}).addTo(map);

  // marker visually-friendly icon
  const deviceIcon = L.divIcon({
    html: `<div style="width:48px;height:48px;border-radius:50%;background:#FFD400;border:3px solid #000;display:flex;align-items:center;justify-content:center;box-shadow:0 0 16px #FFD400"><span style="font-size:22px">üßë‚Äçü¶Ø</span></div>`,
    iconSize:[48,48], iconAnchor:[24,24], className:''
  });

  let marker = L.marker([defaultLat, defaultLng], {icon: deviceIcon}).addTo(map);
  let accuracyCircle = L.circle([defaultLat, defaultLng], {radius: 20, color:'#ffd400', opacity:0.2}).addTo(map);
  let path = L.polyline([], {color:'#FFD400', weight:4, opacity:0.9}).addTo(map);

  // UI elements
  const connectStatusEl = document.getElementById('connectStatus');
  const latlngEl = document.getElementById('latlng');
  const lastUpdateEl = document.getElementById('lastUpdate');
  const distanceEl = document.getElementById('distance');
  const alertsEl = document.getElementById('alerts');
  const gpsStatusEl = document.getElementById('gpsStatus');
  const centerBtn = document.getElementById('centerBtn');
  const followBtn = document.getElementById('followBtn');

  let follow = true;
  followBtn.addEventListener('click', ()=> {
    follow = !follow;
    followBtn.textContent = follow ? 'üîÅ Follow' : 'üõë Follow';
    followBtn.setAttribute('aria-pressed', follow);
  });
  centerBtn.addEventListener('click', ()=> map.panTo(marker.getLatLng()));

  // helper: format timestamp
  function nowString(){ return new Date().toLocaleString('en-PH', {hour12:false}); }

  // Status logic (same thresholds as ESP)
  function computeStatus(distance){
    // treat invalid as safe
    if (distance === null || typeof distance === 'undefined' || isNaN(distance) || distance < 0) {
      return { label: '‚úÖ Safe', className: 'safe' };
    }
    if (distance >= 150) return { label: '‚úÖ Safe', className: 'safe' };
    if (distance >= 30) return { label: 'üü° Mild Warning', className: 'mild' };
    return { label: 'üî¥ SOS ‚Äî Send Help!', className: 'danger' };
  }

  // Realtime listener
  const shoeRef = db.ref('shoe');
  shoeRef.on('value', snapshot => {
    const data = snapshot.val();
    if (!data) {
      connectStatusEl.textContent = 'No data';
      connectStatusEl.style.background = '#666';
      return;
    }

    connectStatusEl.textContent = 'Online';
    connectStatusEl.style.background = 'var(--success)';

    const lat = (typeof data.latitude === 'number') ? data.latitude : defaultLat;
    const lng = (typeof data.longitude === 'number') ? data.longitude : defaultLng;
    const distance = (typeof data.distance === 'number') ? data.distance : -1;
    const gpsValid = !!data.gpsValid || (typeof data.latitude === 'number' && typeof data.longitude === 'number');

    // Update marker + path
    marker.setLatLng([lat, lng]);
    accuracyCircle.setLatLng([lat, lng]);
    // optionally set radius from accuracy field if you send one: accuracyCircle.setRadius(data.accuracy || 8);
    path.addLatLng([lat, lng]);
    if (path.getLatLngs().length > 300) {
      const arr = path.getLatLngs().slice(-300);
      path.setLatLngs(arr);
    }

    if (follow) map.panTo([lat, lng], {animate:true, duration:0.6});

    // Update UI
    latlngEl.textContent = `${lat.toFixed(6)} , ${lng.toFixed(6)}`;
    lastUpdateEl.textContent = nowString();
    distanceEl.textContent = (distance >= 0 && distance < 10000) ? `${distance.toFixed(1)} cm` : '‚Äî';
    gpsStatusEl.textContent = gpsValid ? 'GPS OK' : 'No Fix';

    // Alerts & badge
    const status = computeStatus(distance);
    alertsEl.textContent = status.label;
    alertsEl.className = 'status-pill ' + status.className;

    // small visual feedback for danger: flash map center
    if (status.className === 'danger') {
      // tiny pulse effect by zooming in a bit then back
      map.flyTo([lat, lng], Math.max(17, map.getZoom()), {duration: 0.7});
    }
  });

  // handle connection errors
  shoeRef.on('cancel', err => {
    connectStatusEl.textContent = 'DB Error';
    connectStatusEl.style.background = '#a00';
    console.error('Firebase listener canceled', err);
  });

  // ensure map displays correctly on load
  setTimeout(() => map.invalidateSize(), 150);
  </script>
</body>
</html>
