<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>S.T.E.P ‚Äî Guardian Monitoring (Realtime)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
:root{--bg:#0d0d0d;--card:#141414;--accent:#FFD400;--text:#eaeaea;--muted:#aaa;--success:#4CAF50;--warning:#FFC107;--danger:#ff4d4d;}
html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,Poppins,sans-serif;}
header{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;border-bottom:2px solid #111;background:linear-gradient(90deg,#000,#111);color:var(--accent);font-weight:700}
main{display:grid;grid-template-columns:2fr 1fr;height:calc(100% - 64px);}
#map{width:100%;height:100%}
.panel{background:var(--card);padding:18px;display:flex;flex-direction:column;gap:12px;border-left:2px solid #222;box-shadow:inset 0 0 12px rgba(255,212,0,0.03);overflow:auto}
.title{font-size:18px;color:var(--accent);font-weight:700;text-align:center}
.row{display:flex;justify-content:space-between;align-items:center;background:#0f0f0f;border-radius:10px;padding:10px;border:1px solid #222}
.label{color:var(--muted);font-size:13px}
.value{color:var(--accent);font-weight:700}
.status{padding:10px;border-radius:8px;text-align:center;font-weight:800}
.safe{background:var(--success);color:#000}
.mild{background:var(--warning);color:#000}
.danger{background:var(--danger);color:#000;animation:blink 1s infinite alternate}
@keyframes blink{0%{opacity:1}100%{opacity:0.5}}
footer{padding:10px;text-align:center;color:var(--muted);font-size:12px;border-top:1px solid #111}
.leaflet-marker-icon{transition: transform 0.6s ease;}
@media(max-width:900px){main{grid-template-columns:1fr;grid-template-rows:1fr 0.9fr}.panel{border-left:none;border-top:2px solid #222}}
</style>
</head>
<body>
<header>
<div>üëü S.T.E.P ‚Äî Guardian Monitoring</div>
<div id="connectStatus" style="background:var(--muted);padding:8px 12px;border-radius:8px;color:#000;font-weight:700">Connecting...</div>
</header>
<main>
<div id="map" aria-label="Map showing device location"></div>
<div class="panel" role="region" aria-label="Device information">
  <div class="title">Device Information</div>
  <div class="row"><div class="label">Last Location</div><div id="latlng" class="value">‚Äî , ‚Äî</div></div>
  <div class="row"><div class="label">Distance</div><div id="distance" class="value">‚Äî cm</div></div>
  <div class="row"><div class="label">Last Update</div><div id="lastUpdate" class="value">‚Äî</div></div>
  <div id="alerts" class="status safe" role="status" aria-live="polite">‚úÖ Safe</div>
  <div style="margin-top:auto;display:flex;gap:8px;">
    <button id="centerBtn" style="flex:1;padding:10px;border-radius:8px;border:none;background:var(--accent);font-weight:800;cursor:pointer">üìç Center Map</button>
    <button id="fitBtn" style="flex:1;padding:10px;border-radius:8px;border:none;background:#333;color:var(--accent);font-weight:700;cursor:pointer">üîé Fit Path</button>
  </div>
</div>
</main>
<footer>¬© 2025 S.T.E.P ‚Äî Guardian Monitoring</footer>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyCEPsPPxprCkb70JAre73vo0jo3YA6uZQ4",
  authDomain: "step-gps-tracker.firebaseapp.com",
  databaseURL: "https://step-gps-tracker-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "step-gps-tracker",
  storageBucket: "step-gps-tracker.firebasestorage.app",
  messagingSenderId: "637274580153",
  appId: "1:637274580153:web:7566f774dbf5ea4380a768"
};

const MAX_DETECT = 150;
const SOS_THRESHOLD = 30;

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const shoeRef = db.ref('shoe');

const defaultLat = 14.3, defaultLng = 121.4;
const map = L.map('map', {zoomControl:true}).setView([defaultLat, defaultLng],16);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'¬© OpenStreetMap contributors'}).addTo(map);

const stepIcon = L.divIcon({
  className:'step-icon',
  html:'<div style="width:44px;height:44px;border-radius:50%;background:#FFD400;border:2px solid #000;display:flex;align-items:center;justify-content:center;font-size:22px;">üëü</div>',
  iconSize:[44,44], iconAnchor:[22,22]
});
let marker = L.marker([defaultLat,defaultLng],{icon:stepIcon}).addTo(map).bindPopup('STEP device');
let pathCoords = [];
let pathLine = L.polyline(pathCoords,{color:'#FFD400', weight:4, opacity:0.9}).addTo(map);

const connectStatusEl = document.getElementById('connectStatus');
const latlngEl = document.getElementById('latlng');
const distanceEl = document.getElementById('distance');
const lastUpdateEl = document.getElementById('lastUpdate');
const alertsEl = document.getElementById('alerts');
const centerBtn = document.getElementById('centerBtn');
const fitBtn = document.getElementById('fitBtn');

centerBtn.addEventListener('click',()=>{map.panTo(marker.getLatLng()); map.setZoom(18)});
fitBtn.addEventListener('click',()=>{if(pathCoords.length) map.fitBounds(pathLine.getBounds(),{padding:[30,30]})});

function fmtCoord(x){return (typeof x==='number')?x.toFixed(6):'‚Äî';}
let lastLat=null,lastLng=null;

shoeRef.on('value',snap=>{
  const data=snap.val();
  if(!data){connectStatusEl.textContent='No Data';connectStatusEl.style.background='#777';return;}

  connectStatusEl.textContent='Online';connectStatusEl.style.background='#4CAF50';

  const lat=Number(data.latitude)||defaultLat;
  const lng=Number(data.longitude)||defaultLng;
  const distance=Number(data.distance)||0;
  const sos=!!data.sos;

  const moved=(lastLat!==lat||lastLng!==lng);
  if(moved){
    marker.setLatLng([lat,lng]);
    map.panTo([lat,lng],{animate:true,duration:0.8});
    const delta=(lastLat===null)?9999:Math.hypot(lat-lastLat,lng-lastLng);
    if(delta>0 && delta<9999){pathCoords.push([lat,lng]);if(pathCoords.length>500) pathCoords.shift(); pathLine.setLatLngs(pathCoords);}
    else if(lastLat===null){pathCoords.push([lat,lng]);pathLine.setLatLngs(pathCoords);}
    lastLat=lat;lastLng=lng;
  }

  latlngEl.textContent=`${fmtCoord(lat)} , ${fmtCoord(lng)}`;
  distanceEl.textContent=`${distance.toFixed(1)} cm`;
  lastUpdateEl.textContent=new Date().toLocaleString('en-PH',{hour12:false});

  if(sos || distance<=SOS_THRESHOLD){alertsEl.textContent='üî¥ STRONG BEEP ‚Äî Danger! (SOS)';alertsEl.className='status danger'}
  else if(distance<=MAX_DETECT){alertsEl.textContent='üü° MILD BEEP ‚Äî Warning';alertsEl.className='status mild'}
  else{alertsEl.textContent='‚úÖ Safe';alertsEl.className='status safe'}
});
</script>
</body>
</html>
